<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karachi Pre-Medical Career Dashboard (Eligibility Focus)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: The SPA prioritizes eligibility for application/entry test access. The percentage slider filters fields based on the lowest mandatory minimum percentage (minEligibilityPercentage). The cards display based on this low bar, emphasizing application access. The expanded card view details specific university requirements, clearly separating the low eligibility bar from the high competitive merit cutoff. The dynamic chart and LLM sections are retained to provide a full analytical experience. This structure gives the user a broader view of their application landscape while still providing the tough reality of competitive cutoffs. -->
    <!-- Visualization & Content Choices: 
        1. Percentage Filter: Report Info -> Student's Intermediate Percentage. Goal -> Filter options based on MINIMUM eligibility. Viz/Method -> HTML Range Slider. Interaction -> Filters and re-renders the career cards based on minEligibilityPercentage.
        2. University Requirements: Report Info -> Specific university entrance requirements. Goal -> Detail & Action. Viz/Method -> Dynamic HTML List within card. Interaction -> University entries are highlighted if the student's score meets the low eligibility bar for that field. Notes clarify that final merit will be much higher.
        3. Gemini API Integration: (FIXED) Goal -> Personalize advice and enable complex comparisons. Viz/Method -> Button-triggered LLM API call, now using the correct model endpoint to ensure functionality.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4;
            color: #333333;
        }
        .card {
            background-color: #FFFFFF;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        .card-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
        }
        .card.open .card-details {
            max-height: 3500px; 
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4A90E2;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -8px;
        }
        .slider-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #d1d5db;
            border-radius: 9999px;
        }
        input[type='range']::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4A90E2;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -8px;
        }
        input[type='range']::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4A90E2;
            border-radius: 50%;
            cursor: pointer;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: auto;
            max-height: 400px;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-5xl font-bold text-gray-800">Career Pathways Dashboard</h1>
            <p class="mt-2 md:mt-4 text-base md:text-lg text-gray-600">For Pre-Medical Students of Karachi Board (HSC-II)</p>
        </header>

        <main>
            <div class="sticky top-0 bg-opacity-80 backdrop-blur-md bg-[#F8F7F4] z-10 py-6 mb-8 rounded-lg shadow-sm">
                <div class="max-w-2xl mx-auto">
                    <label for="percentage-slider" class="block text-center font-semibold text-lg text-gray-700 mb-2">
                        Your Intermediate (XII) Percentage: <span id="percentage-value" class="font-bold text-2xl text-[#4A90E2]">75%</span>
                    </label>
                    <input id="percentage-slider" type="range" min="50" max="100" value="75" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-track">
                </div>
            </div>
            
            <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg mb-8">
                <p class="font-semibold">IMPORTANT: Eligibility vs. Admission</p>
                <p class="text-sm">The fields shown below are those you are **ELIGIBLE TO APPLY** for (based on HEC/P.M.C. minimum percentages). Your final admission depends on competitive merit, which is often much higher than the minimum shown here, and is heavily reliant on your **Entry Test Score**.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 md:gap-12">
                <div class="lg:col-span-2">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Fields Open for Application & Entry Test</h2>
                    <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
                </div>

                <div class="lg:col-span-1">
                     <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center lg:text-left">Opportunity Overview</h2>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <p class="text-center text-gray-600 mb-4">This chart summarizes the types of eligible fields open to you for application.</p>
                        <div class="chart-container">
                            <canvas id="opportunityChart"></canvas>
                        </div>
                     </div>
                </div>
            </div>

            <!-- Global LLM Custom Query Section -->
            <section class="mt-12 p-6 bg-white rounded-lg shadow-xl border-t-4 border-[#BD10E0]">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">✨ Career Analyst Custom Query</h2>
                <p class="text-gray-600 mb-4">Ask a strategic question about entry tests, competition, or career comparison, tailored to your **<span id="llm-percent-display" class="font-bold text-[#4A90E2]">75%</span>** score and chosen fields.</p>
                
                <textarea id="custom-query-input" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-[#4A90E2] focus:border-[#4A90E2]" placeholder="Example: Given my score, what preparation strategy should I adopt to maximize my chances of getting into the DPT program at DUHS or Ziauddin?"></textarea>
                
                <button id="custom-query-button" class="mt-4 w-full md:w-auto px-6 py-3 bg-[#BD10E0] text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition duration-150 flex items-center justify-center disabled:opacity-50" onclick="handleCustomQuery()">
                    <div id="custom-query-loading" class="hidden loading-spinner mr-3"></div>
                    ✨ Analyze & Advise
                </button>
                
                <div id="custom-query-result" class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 whitespace-pre-wrap hidden">
                    <!-- LLM result will be displayed here -->
                </div>
            </section>
        </main>
    </div>

    <script>
        const apiKey = "";
        // FIXED: Using the current, supported model for reliable API access
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // --- UPDATED DATA STRUCTURE WITH BBSUL ADDED TO PHARM-D ---
        const careerData = [
            {
                name: "MBBS / BDS (Medicine & Dentistry)",
                minEligibilityPercentage: 60, // P.M.C. minimum for applying to public/private medical colleges
                category: "Core Medical",
                importance: "The primary medical degree. Success relies heavily on MDCAT performance.",
                careerPakistan: "High demand in hospitals, clinics, and research.",
                careerAbroad: "Highly recognized worldwide, requires licensing exams (USMLE/PLAB).",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form, Domicile, PRC, MDCAT Score (mandatory).",
                universities: [
                    { uniName: "Dow University of Health Sciences (DUHS)", avgCutoff: 90, notes: "Top Public Sector. Final admission merit is extremely high (Inter + MDCAT)." },
                    { uniName: "Jinnah Sindh Medical University (JSMU)", avgCutoff: 87, notes: "Public Sector. Very high merit required. MDCAT mandatory." },
                    { uniName: "Shaheed Mohtarma Benazir Bhutto Medical College (SMBBMC)", avgCutoff: 84, notes: "Public Sector (Lyari). High competition; merit comparable to other public colleges." },
                    { uniName: "Karachi Metropolitan University (KMU)", avgCutoff: 85, notes: "Public/Trust Sector. Requires high combined merit." },
                    { uniName: "Aga Khan University (AKU)", avgCutoff: 85, notes: "Private. Requires AKU entry test and interview. Merit is high." },
                    { uniName: "Liaquat University of Medical & Health Sciences (LUMHS, Jamshoro)", avgCutoff: 84, notes: "Public Sector (Sindh Quota). Competitive merit." },
                    { uniName: "Ziauddin University", avgCutoff: 78, notes: "Private. Requires university entrance test." },
                    { uniName: "Indus University", avgCutoff: 75, notes: "Private. Competitive merit. Check HEC recognition." }
                ]
            },
            {
                name: "Pharm-D (Doctor of Pharmacy)",
                minEligibilityPercentage: 60, // HEC general eligibility for D-level programs
                category: "Allied Health",
                importance: "A professional doctorate focused on drugs, patient care, and industry.",
                careerPakistan: "Roles in pharmaceutical industry (R&D, production), hospitals, and retail.",
                careerAbroad: "High demand in developed countries after local licensing.",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form.",
                universities: [
                    { uniName: "University of Karachi (UoK)", avgCutoff: 75, notes: "Top Public Sector. High competitive merit, entry test required." },
                    { uniName: "Dow University (DCOP)", avgCutoff: 70, notes: "Good public option. Admissions usually in Fall." },
                    { uniName: "Hamdard University", avgCutoff: 65, notes: "Private. Well-recognized institution. Admissions Sep-Nov." },
                    { uniName: "Sohail University (Faculty of Pharmacy)", avgCutoff: 62, notes: "Private, recognized institution. Competitive entry test." },
                    { uniName: "Benazir Bhutto Shaheed University of Technology and Skills Education (BBSUL)", avgCutoff: 61, notes: "Public sector option. Merit is competitive; check specific entrance test requirements." },
                    { uniName: "Iqra University (IU)", avgCutoff: 60, notes: "Private sector option. Entrance test may be required." }
                ]
            },
            {
                name: "DPT (Doctor of Physical Therapy)",
                minEligibilityPercentage: 50, // HEC general eligibility for 4/5-year programs
                category: "Allied Health",
                importance: "Focuses on physical rehabilitation and restoring function.",
                careerPakistan: "High growth in hospitals, rehab centers, and private clinics.",
                careerAbroad: "Very high demand in North America and Europe.",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form.",
                universities: [
                    { uniName: "Ziauddin University", avgCutoff: 70, notes: "Reputable private option. May require entrance test." },
                    { uniName: "Dow University of Health Sciences (DUHS)", avgCutoff: 68, notes: "Highly competitive public sector seats." },
                    { uniName: "Iqra University (IU)", avgCutoff: 62, notes: "Major private sector option in Karachi. Test/Interview required." },
                    { uniName: "PNF Institute of Physical Medicine", avgCutoff: 65, notes: "Well-established public/private hybrid." },
                    { uniName: "Karachi Metropolitan University (KMU)", avgCutoff: 60, notes: "Competitive Trust/Public sector option." }
                ]
            },
            {
                name: "BS in Nursing (BSN)",
                minEligibilityPercentage: 50, // P.N.C. minimum for applying to BSN programs
                category: "Allied Health",
                importance: "A vital, globally in-demand healthcare profession.",
                careerPakistan: "Consistently high demand in all healthcare settings.",
                careerAbroad: "Extremely high demand globally (Middle East, UK, Ireland).",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form.",
                universities: [
                    { uniName: "Aga Khan University (AKU)", avgCutoff: 75, notes: "Highest merit, test-based admission, excellent career progression." },
                    { uniName: "DUHS College of Nursing", avgCutoff: 65, notes: "Highly competitive public sector seats." },
                    { uniName: "JPMC College of Nursing", avgCutoff: 60, notes: "Government sector, high merit for public seats." },
                    { uniName: "Iqra University (IU)", avgCutoff: 58, notes: "Private sector option." }
                ]
            },
            {
                name: "BS in Biosciences (Microbiology, Biotech, etc.)",
                minEligibilityPercentage: 50, // HEC general eligibility for BS programs
                category: "Biological Sciences",
                importance: "Foundation for research, medicine, and industrial applications. Often requires a postgraduate degree.",
                careerPakistan: "Growing scope in research labs, diagnostics, and pharmaceutical QC.",
                careerAbroad: "Excellent opportunities for MS/PhD leading to research and industry roles.",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form.",
                universities: [
                    { uniName: "LUMS (School of Science & Engineering)", avgCutoff: 85, notes: "Extremely high merit, requires SAT/LUMS test. National reach." },
                    { uniName: "University of Karachi (UoK)", avgCutoff: 65, notes: "Top Public sector. High competitive merit for public seats." },
                    { uniName: "NUST (National University of Sciences & Tech)", avgCutoff: 78, notes: "National level institution. Requires NET test." },
                    { uniName: "COMSATS University Islamabad (Karachi Campus)", avgCutoff: 68, notes: "Reputable institute. Entrance test required." },
                    { uniName: "Federal Urdu University (FUUAST)", avgCutoff: 55, notes: "Accessible public option. Merit based on test/interview." }
                ]
            },
            {
                name: "BS in Computer Science (BSCS)",
                minEligibilityPercentage: 50, // HEC general eligibility (with math requirement at some unis)
                category: "Tech Field (Alternate)",
                importance: "The booming tech industry. Pre-meds can enter but often need to pass an additional math exam/module.",
                careerPakistan: "Vast opportunities in software houses and freelance work. Highest-paying field.",
                careerAbroad: "Globally in-demand, excellent for remote work or immigration.",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form.",
                universities: [
                    { uniName: "Institute of Business Administration (IBA)", avgCutoff: 85, notes: "Highest merit. Requires strong math background and entry test (SBC)." },
                    { uniName: "Habib University", avgCutoff: 75, notes: "Liberal Arts core, high merit. Accepts pre-meds with strong aptitude scores." },
                    { uniName: "NED University of Engineering & Tech", avgCutoff: 70, notes: "Public technical option. Requires pre-engineering or equivalent math background/test." },
                    { uniName: "Air University (AU)", avgCutoff: 65, notes: "Good national option. Requires a strong entry test score." },
                    { uniName: "Dawood University of Engineering & Tech", avgCutoff: 60, notes: "Public technical option. Test required." },
                    { uniName: "Iqra University (IU)", avgCutoff: 55, notes: "Accessible private option, competitive entry test." }
                ]
            },
            {
                name: "BS in Medical Technology / Public Health",
                minEligibilityPercentage: 50,
                category: "Allied Health",
                importance: "Specialized diagnostics (Tech) or community health (Public Health). Both crucial supportive fields.",
                careerPakistan: "High demand in clinical labs and NGOs/government health departments.",
                careerAbroad: "Consistent global demand for skilled technologists and public health officers.",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form.",
                universities: [
                    { uniName: "Jinnah Sindh Medical University (JSMU - Public Health)", avgCutoff: 68, notes: "Competitive public health programs." },
                    { uniName: "Dow University (DUHS - Medical Tech)", avgCutoff: 65, notes: "Competitive public sector seats for various technologies (e.g., Radiology, Lab)." },
                    { uniName: "Ziauddin University", avgCutoff: 60, notes: "Private sector options for Medical Technology." }
                ]
            },
            {
                name: "BS in Social Sciences / Liberal Arts",
                minEligibilityPercentage: 50,
                category: "Liberal Arts (Alternate)",
                importance: "Includes fields like Economics, Psychology, and Media Studies. Requires strong analytical skills.",
                careerPakistan: "Diverse roles in corporate sector, development, and journalism.",
                careerAbroad: "Highly valued for critical thinking in global consulting and policy roles.",
                documents: "Matric, Inter Mark Sheet, CNIC/B-Form.",
                universities: [
                    { uniName: "LUMS (School of Humanities)", avgCutoff: 78, notes: "Top national option. Requires SAT/LUMS test." },
                    { uniName: "Habib University", avgCutoff: 70, notes: "Strong liberal arts focus. Entrance test required." },
                    { uniName: "University of Karachi (UoK)", avgCutoff: 55, notes: "Accessible public option for Psychology/Economics." },
                    { uniName: "Iqra University (IU - Media/Management)", avgCutoff: 50, notes: "Wide range of programs available." },
                    { uniName: "Federal Urdu University (FUUAST - Mass Comm)", avgCutoff: 50, notes: "Accessible public option." }
                ]
            }
        ];
        // --- END UPDATED DATA STRUCTURE ---

        const slider = document.getElementById('percentage-slider');
        const percentageValue = document.getElementById('percentage-value');
        const cardsContainer = document.getElementById('cards-container');
        const opportunityChartCanvas = document.getElementById('opportunityChart').getContext('2d');
        const llmPercentDisplay = document.getElementById('llm-percent-display');
        let opportunityChart;

        const categoryColors = {
            'Core Medical': '#4A90E2',
            'Allied Health': '#50E3C2',
            'Biological Sciences': '#F5A623',
            'Tech Field (Alternate)': '#BD10E0',
            'Liberal Arts (Alternate)': '#10B981',
            'STEM (Alternate)': '#EF4444'
        };

        async function callGeminiApi(systemPrompt, userQuery, maxRetries = 5, useGrounding = true) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            if (useGrounding) {
                 payload.tools = [{ "google_search": {} }];
            }

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || 'The AI service returned an empty or unreadable response. Please check your query.';
                    return text;

                } catch (error) {
                    if (i === maxRetries - 1) {
                        // NOTE: If this error occurs on your live site, it means the API key is not being provided or the endpoint is blocked.
                        return `An API error occurred: ${error.message}. Please verify the API settings or try again later.`;
                    }
                }
            }
        }

        async function handlePersonalizedAdvice(careerName, buttonElement, resultElement) {
            buttonElement.disabled = true;
            resultElement.innerHTML = `<div class="flex items-center text-[#4A90E2]"><div class="loading-spinner mr-3"></div> Generating strategic next steps...</div>`;
            resultElement.classList.remove('hidden');

            const systemPrompt = "Act as a specialist career counselor focusing on entry test strategies and skill development for a Pakistani pre-medical student. Your response must be highly actionable, concise, and structured. Focus on steps required to pass competitive entry tests for this specific field.";
            const userQuery = `Given the career choice of ${careerName}, provide three concrete, actionable next steps a student from the Karachi Board should focus on immediately to prepare for the competitive university entry tests and maximize their final admission merit score.`;

            const advice = await callGeminiApi(systemPrompt, userQuery, 5, true);

            resultElement.innerHTML = `
                <h5 class="font-semibold text-gray-800 mb-2">✨ Suggested Strategic Steps:</h5>
                <div class="text-sm text-gray-700">${advice.replace(/\n/g, '<br>')}</div>
            `;
            buttonElement.disabled = false;
        }

        async function handleCustomQuery() {
            const button = document.getElementById('custom-query-button');
            const loading = document.getElementById('custom-query-loading');
            const resultDiv = document.getElementById('custom-query-result');
            const query = document.getElementById('custom-query-input').value.trim();
            const currentPercentage = slider.value;

            if (!query) {
                resultDiv.innerHTML = 'Please enter your question before clicking "Analyze & Advise".';
                resultDiv.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            loading.classList.remove('hidden');
            resultDiv.innerHTML = 'Analyzing and generating comprehensive advice...';
            resultDiv.classList.remove('hidden');

            const systemPrompt = "Act as an expert career analyst and information architect specializing in South Asian and international education and employment markets. Provide a comprehensive, structured response to the user's query, incorporating the fact that the student is from the Karachi Board and is focusing on entry test preparation for high merit fields. Use bolding and lists to ensure the result is easily digestible.";
            const userQuery = `Analyze the following query for a pre-medical student with an Intermediate percentage of ${currentPercentage}% from the Karachi Board: ${query}`;

            const resultText = await callGeminiApi(systemPrompt, userQuery, 5, true);

            resultDiv.innerHTML = resultText.replace(/\n/g, '<br>');
            button.disabled = false;
            loading.classList.add('hidden');
        }

        function createUniversityListHTML(universities, currentPercentage, minEligibilityPercentage) {
            let html = '<ul class="mt-2 space-y-3 max-h-72 overflow-y-auto pr-2">';
            let eligibleToApplyCount = 0;

            universities.forEach(uni => {
                const isEligibleToApply = currentPercentage >= minEligibilityPercentage;
                const baseClass = 'p-3 rounded-lg flex justify-between items-center text-sm';
                let uniClass = baseClass;
                let statusText = `(Est. Final Merit: ${uni.avgCutoff}%)`;

                if (isEligibleToApply) {
                    uniClass += ' bg-green-50 border-l-4 border-green-500 font-semibold';
                    statusText = `<span class="text-green-600 font-bold">APPLY/TEST ELIGIBLE</span>`;
                    eligibleToApplyCount++;
                } else {
                    uniClass += ' bg-gray-50 border-l-4 border-gray-300 text-gray-600';
                    statusText = `<span class="text-red-500">BELOW ELIGIBILITY (${minEligibilityPercentage}%)</span>`;
                }

                html += `
                    <li class="${uniClass}">
                        <div>
                            <span class="font-medium">${uni.uniName}</span>
                            <p class="text-xs text-gray-500">${uni.notes}</p>
                        </div>
                        ${statusText}
                    </li>
                `;
            });
            html += '</ul>';
            
            if (eligibleToApplyCount === 0) {
                 html = `<p class="text-sm text-red-500 font-medium pt-2">Your current score is below the **minimum eligibility percentage** (${minEligibilityPercentage}%) required to apply to any university in this field.</p>` + html;
            } else {
                 html = `<p class="text-sm text-green-700 font-medium pt-2">You meet the **minimum percentage (${minEligibilityPercentage}%)** to apply/sit for the entry test at these universities. <span class="text-gray-600">(Final admission merit will be significantly higher: focus on entry tests!)</span></p>` + html;
            }

            return html;
        }

        function createCard(data, currentPercentage) {
            const card = document.createElement('div');
            card.className = 'card';

            const universityListHTML = createUniversityListHTML(data.universities, currentPercentage, data.minEligibilityPercentage);

            card.innerHTML = `
                <div class="p-5 cursor-pointer">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-gray-800">${data.name}</h3>
                        <span class="text-2xl font-thin text-gray-400 transform transition-transform duration-300">&#x25BC;</span>
                    </div>
                    <p class="text-sm font-medium mt-1" style="color: ${categoryColors[data.category] || '#777'}">${data.category}</p>
                    <p class="text-gray-600 mt-2">${data.importance}</p>
                </div>
                <div class="card-details px-5">
                    <div class="border-t border-gray-200 pt-4">
                        <h4 class="font-bold text-gray-800 mb-2">University Eligibility Checker (For Application)</h4>
                        ${universityListHTML}
                    </div>

                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Career Potential</h4>
                        <p class="text-sm text-gray-600 mb-1"><span class="font-medium">In Pakistan:</span> ${data.careerPakistan}</p>
                        <p class="text-sm text-gray-600"><span class="font-medium">Abroad:</span> ${data.careerAbroad}</p>
                    </div>
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Admission Info (General)</h4>
                        <p class="text-sm text-gray-600 mb-1"><span class="font-medium">Typical Documents:</span> ${data.documents}</p>
                    </div>

                    <!-- Gemini LLM Feature 1: Personalized Advice -->
                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <h4 class="font-semibold text-gray-700 mb-2">Entry Test & Merit Strategy</h4>
                        <button class="llm-advice-button px-4 py-2 bg-[#50E3C2] text-gray-800 font-semibold text-sm rounded-lg hover:bg-[#40C9A5] transition duration-150 flex items-center disabled:opacity-50">
                            ✨ Get Strategic Next Steps for Entry Tests
                        </button>
                        <div class="llm-advice-result mt-3 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-gray-700 hidden">
                            <!-- Advice will load here -->
                        </div>
                    </div>

                </div>
            `;
            
            card.addEventListener('click', () => {
                card.classList.toggle('open');
                const arrow = card.querySelector('.text-2xl');
                arrow.style.transform = card.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
            });

            // Set up LLM button listener
            const adviceButton = card.querySelector('.llm-advice-button');
            const adviceResult = card.querySelector('.llm-advice-result');
            adviceButton.addEventListener('click', (e) => {
                e.stopPropagation(); 
                handlePersonalizedAdvice(data.name, adviceButton, adviceResult);
            });
            
            return card;
        }

        function updateChart(filteredData) {
            const categoryCounts = filteredData.reduce((acc, curr) => {
                acc[curr.category] = (acc[curr.category] || 0) + 1;
                return acc;
            }, {});

            const labels = Object.keys(categoryCounts);
            const data = Object.values(categoryCounts);
            const backgroundColors = labels.map(label => categoryColors[label] || '#CCCCCC');

            if (opportunityChart) {
                opportunityChart.data.labels = labels;
                opportunityChart.data.datasets[0].data = data;
                opportunityChart.data.datasets[0].backgroundColor = backgroundColors;
                opportunityChart.update();
            } else {
                 opportunityChart = new Chart(opportunityChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: '#F8F7F4',
                            borderWidth: 4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14,
                                        family: 'Inter'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed;
                                        }
                                        return label + (context.parsed === 1 ? ' field' : ' fields');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderContent(percentage) {
            percentage = parseInt(percentage); 
            percentageValue.textContent = `${percentage}%`;
            llmPercentDisplay.textContent = `${percentage}%`;
            cardsContainer.innerHTML = '';

            // Filter based on the minimum eligibility percentage for application
            const filteredData = careerData.filter(d => percentage >= d.minEligibilityPercentage);
            
            if (filteredData.length > 0) {
                 filteredData
                    .sort((a, b) => {
                        // Sort by the highest ELIGIBILITY percentage first
                        return b.minEligibilityPercentage - a.minEligibilityPercentage;
                    })
                    .forEach(data => {
                        const card = createCard(data, percentage);
                        cardsContainer.appendChild(card);
                    });
            } else {
                cardsContainer.innerHTML = `<p class="text-center text-gray-500 md:col-span-2">Your score is below the minimum eligibility of 50% required for most BS programs.</p>`;
            }

            updateChart(filteredData);
        }

        slider.addEventListener('input', (event) => {
            renderContent(event.target.value);
        });

        window.addEventListener('load', () => {
            renderContent(slider.value);
        });

    </script>
</body>
</html>
